name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: |
          TAG="${GITHUB_REF#refs/tags/v}"
          echo "version=$TAG" >> "$GITHUB_OUTPUT"
          echo "tag=${GITHUB_REF#refs/tags/}" >> "$GITHUB_OUTPUT"
          echo "date=$(date +%Y-%m-%d)" >> "$GITHUB_OUTPUT"

      - name: Finalize CHANGELOG
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="${{ steps.version.outputs.tag }}"
          DATE="${{ steps.version.outputs.date }}"
          PREV_TAG=$(git tag --sort=-v:refname | grep '^v' | sed -n '2p')

          # Replace [Unreleased] header with version + date, add new Unreleased block
          sed -i "s/^## \[Unreleased\]/## [Unreleased]\n\n## [$VERSION] - $DATE/" docs/CHANGELOG.md

          # Update unreleased compare link to point to new tag
          sed -i "s|\[unreleased\]: .*|[unreleased]: https://github.com/${{ github.repository }}/compare/$TAG...HEAD|" docs/CHANGELOG.md

          # Add compare link for the new version (before the previous version's link)
          if [ -n "$PREV_TAG" ]; then
            sed -i "/^\[$PREV_TAG\]/i [$VERSION]: https://github.com/${{ github.repository }}/compare/$PREV_TAG...$TAG" docs/CHANGELOG.md
          fi

      - name: Commit CHANGELOG update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/CHANGELOG.md
          git diff --cached --quiet && exit 0
          git commit -m "doc: finalize CHANGELOG for ${{ steps.version.outputs.tag }}"
          git push origin main

      - name: Extract release notes from CHANGELOG
        id: notes
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Extract content between this version header and the next version header
          NOTES=$(sed -n "/^## \[$VERSION\]/,/^## \[/{ /^## \[$VERSION\]/d; /^## \[/d; p; }" docs/CHANGELOG.md)
          # Write to file for gh release
          echo "$NOTES" > /tmp/release-notes.md

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release create "${{ steps.version.outputs.tag }}" \
            --title "${{ steps.version.outputs.tag }}" \
            --notes-file /tmp/release-notes.md
